
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>ç™¾åº¦åœ°å›¾APIè·¯ä¹¦å®ç°å†å²è½¨è¿¹å›æ”¾</title>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=03EV2mS83xtLoifvHnRm5MTx5krHDIg0"></script>
        <script type="text/javascript" src="./lushu.js"></script>
        <script type="text/javascript"  src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<!-- è·¯ä¹¦åŠŸèƒ½ -->
        <!-- <script src="http://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js"></script> -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
        <script src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js"></script>
        <style>
            .custom-infobox {
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 20px;
                min-width: 280px;
            }
            
            .info-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .company-logo {
                width: 40px;
                height: 40px;
                margin-right: 12px;
            }
            
            .contact-btn {
                background: #4CAF50;
                color: white;
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: opacity 0.3s;
            }
            
            .contact-btn:hover {
                opacity: 0.9;
            }
            </style>
	</head>
	<body>
		<!-- åœ¨æ­¤å¤„æ·»åŠ æ§åˆ¶æŒ‰é’®å’Œæ»‘åŠ¨æ¡ -->
		<div id="controls">
			<!-- å¼€å§‹æŒ‰é’® -->
			<button onclick="start()">å¼€å§‹</button>
			<!-- æš‚åœæŒ‰é’® -->
			<button onclick="pause()">æš‚åœ</button>
			<!-- ç»§ç»­æŒ‰é’® -->
			<button onclick="resume()">ç»§ç»­</button>
			 <!-- æš‚åœæŒ‰é’® -->
			<button onclick="stop()">åœæ­¢</button>
            <span>æ’­æ”¾é€Ÿåº¦</span>
            <input type="range" id="speed">
            <!-- æ’­æ”¾è¿›åº¦æ¡ -->
			<span>æ’­æ”¾è¿›åº¦</span>
			<input type="range" id="process">
		</div>
		<div id="allmap" style="position: absolute; width: 100%; top: 50px; bottom: 0px"></div>
		    
	<script type="text/javascript">
        //æ–¹æ³•é‡å†™
        BMapLib.LuShu.prototype._move = function(initPos,targetPos,effect) {
            //è¿›åº¦æ¡çš„è®¾ç½®
            $('#process').slider('setValue', this.i);
            var me = this,
                //å½“å‰çš„å¸§æ•°
                currentCount = 0,
                //æ­¥é•¿ï¼Œç±³/ç§’
                timer = this._opts.speed / 50,
                step = this._opts.speed / (100 / timer),
                //åˆå§‹åæ ‡
                init_pos = this._projection.lngLatToPoint(initPos),
                //è·å–ç»“æŸç‚¹çš„(x,y)åæ ‡
                target_pos = this._projection.lngLatToPoint(targetPos),
                //æ€»çš„æ­¥é•¿
                count = Math.round(me._getDistance(init_pos, target_pos) / step);

            //å¦‚æœå°äº1ç›´æ¥ç§»åŠ¨åˆ°ä¸‹ä¸€ç‚¹
            if (count < 1) {
                me._moveNext(++me.i);
                return;
            }
            //ä¸¤ç‚¹ä¹‹é—´åŒ€é€Ÿç§»åŠ¨
            me._intervalFlag = setInterval(function() {
                //ä¸¤ç‚¹ä¹‹é—´å½“å‰å¸§æ•°å¤§äºæ€»å¸§æ•°çš„æ—¶å€™ï¼Œåˆ™è¯´æ˜å·²ç»å®Œæˆç§»åŠ¨
                if (currentCount >= count) {
                    clearInterval(me._intervalFlag);
                    //ç§»åŠ¨çš„ç‚¹å·²ç»è¶…è¿‡æ€»çš„é•¿åº¦
                    if(me.i > me._path.length){
                        return;
                    }
                    //è¿è¡Œä¸‹ä¸€ä¸ªç‚¹
                    me._moveNext(++me.i);
                }else {
                    currentCount++;
                    var x = effect(init_pos.x, target_pos.x, currentCount, count),
                        y = effect(init_pos.y, target_pos.y, currentCount, count),
                        pos = me._projection.pointToLngLat(new BMap.Pixel(x, y));
                    //è®¾ç½®marker
                    if(currentCount == 1){
                        var proPos = null;
                        if(me.i - 1 >= 0){
                            proPos = me._path[me.i - 1];
                        }
                        if(me._opts.enableRotation == true){
                            me.setRotation(proPos,initPos,targetPos);
                        }
                        // if(me._opts.autoView){
                        //     if(!me._map.getBounds().containsPoint(pos)){
                        //         me._map.setCenter(pos);
                        //     }
                        // }
                    }
                    //æ­£åœ¨ç§»åŠ¨
                    me._marker.setPosition(pos);
                    //è®¾ç½®è‡ªå®šä¹‰overlayçš„ä½ç½®
                    me._setInfoWin(pos);
                }
            },timer);
        }

		
        var map = new BMap.Map("allmap", { minZoom: 9, maxZoom: 19 });
        var point = new BMap.Point(116.128554, 24.294562);
        var top_left_navigation = new BMap.NavigationControl();
        map.enableScrollWheelZoom();//å¯ç”¨æ»šè½®æ”¾å¤§ç¼©å°
		//ä¸­å¿ƒç‚¹åæ ‡
		var carCenterPoint = new BMap.Point(113.400827,23.17394);
		map.centerAndZoom(carCenterPoint , 16);
		
		var pois = [];
        var latLngArray = [
			{path:"113.408984,23.174023", color:'#67C23A', marker: '1', text: '' },
            {path:"113.406639,23.174023", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.403944,23.173566", color:'#67C23A', marker: '2', text: 'æ•…éšœ'  },
            {path:"113.400827,23.17394", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.397468,23.174496", color:'#409EFF', marker: '2', text: 'åœè½¦'  },
            {path:"113.391494,23.174513", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.389032,23.174588", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388736,23.173217", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388511,23.171888", color:'#F56C6C', marker: '2', text: 'äº‹æ•…å‡ºå‚'  },
            {path:"113.388592,23.170501", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.38861,23.170219", color:'#F56C6C', marker: '2', text: 'å……ç”µ'  },
            {path:"113.38861,23.168342", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.388574,23.165218", color:'#F56C6C', marker: '1', text: ''  },
		];


        //============ç»˜åˆ¶è·¯å¾„===============
        // æ­¥éª¤1: è½¬æ¢æ•°æ®ç»“æ„
        const points = latLngArray.map(item => {
            const [lng, lat] = item.path.split(',').map(coord => parseFloat(coord).toFixed(6)); // ä¿ç•™6ä½å°æ•°
            return {
                point: new BMap.Point(lng, lat),
                color: item.color
            };
        });

        // æ­¥éª¤2: è‡ªåŠ¨åˆ†æ®µé€»è¾‘
        let segments = [];
        let currentColor = points[0].color;
        let startIdx = 0;
        for (let i = 1; i < points.length; i++) {
            if (points[i].color !== currentColor) {
                // å½“å‰æ®µåŒ…å« startIdx åˆ° iï¼ˆå«iä½œä¸ºç«¯ç‚¹ï¼‰
                segments.push({
                    start: startIdx,
                    end: i,          // åŸä¸º i-1ï¼Œç°æ”¹ä¸ºåŒ…å«i
                    color: currentColor
                });
                currentColor = points[i].color;
                startIdx = i;        // æ–°æ®µä»iå¼€å§‹ï¼ˆå¤ç”¨å½“å‰ç‚¹ï¼‰
            }
        }
        // æ·»åŠ æœ€åä¸€æ®µæ—¶éœ€åŒ…å«å‰©ä½™ç‚¹
        segments.push({ start: startIdx, end: points.length - 1, color: currentColor });
        // æ­¥éª¤3: ç»˜åˆ¶å„æ®µè·¯å¾„
        segments.forEach(seg => {
            // æå–æœ¬æ®µç‚¹åæ ‡
            const subPoints = points.slice(seg.start, seg.end + 1).map(p => p.point);
            pois.push(...subPoints);
            // åˆ›å»ºçº¿æ®µï¼ˆè‡³å°‘2ä¸ªç‚¹ï¼‰
            if (subPoints.length >= 2) {
                const polyline = new BMap.Polyline(subPoints, {
                    strokeColor: seg.color,
                    strokeWeight: 10,
                    strokeOpacity: 1,
                    enableClicking: true 
                });
                polyline.segmentColor = seg.color;
                polyline.addEventListener('click', function(e) {
                    markerManager.resetLabelStyle()
                    let infoBoxPos = e.point;
                    const clickedColor = this.segmentColor;
                    const infoContent = `
                        <div class="custom-infobox">
                            <div class="info-header">
                                <h3 style="margin:0">å¦é—¨åˆ›æ„äº’åŠ¨ç½‘ç»œ</h3>
                            </div>
                            <div class="info-body">
                                <p>${clickedColor}</p>
                            </div>
                        </div>
                    `;
                    openBox(infoBoxPos, infoContent)
                });
                map.addOverlay(polyline);
            }
        });


        //======================ç»˜åˆ¶è·¯ä¹¦================
		//æ·»åŠ è·¯ä¹¦å›¾æ ‡
		var ls_icons = new BMap.Icon("./public/static/images/car_move_icon.png", new BMap.Size(42, 22),{imageSize: new BMap.Size(42, 22)});
		//è·¯ä¹¦é»˜è®¤ä¿¡æ¯çª—å£å†…å®¹
		var trackContent = "æŸè½¦è¾†è½¨è¿¹å›æ”¾";
		//æ·»åŠ è·¯ä¹¦
		var lushu = new BMapLib.LuShu(map,pois,{
			defaultContent: trackContent,
			icon: ls_icons,
			autoView: false,//æ˜¯å¦å¼€å¯è‡ªåŠ¨è§†é‡è°ƒæ•´ï¼Œå¦‚æœå¼€å¯é‚£ä¹ˆè·¯ä¹¦åœ¨è¿åŠ¨è¿‡ç¨‹ä¸­ä¼šæ ¹æ®è§†é‡è‡ªåŠ¨è°ƒæ•´
			speed: 50,
			enableRotation: true,//æ˜¯å¦è®¾ç½®markeréšç€é“è·¯çš„èµ°å‘è¿›è¡Œæ—‹è½¬
            landmarkPois: [],
		});
        var speedEl = new Slider('#speed', {
			min: 1, //æœ€å°å€¼
			max: 500, //æœ€å¤§å€¼
			step: 50, //æ­¥é•¿
			value: 100, //é»˜è®¤å€¼
		});
		speedEl.on("change", function (obj) { //æ»‘åŠ¨æ¡æ”¹å˜äº‹ä»¶
			var value = obj.newValue;
			if (lushu != null) {
				lushu._opts.speed = parseInt(value);
			}			
		});
        var processEl = $('#process').slider({
            orientation: "horizontal", //æ’åˆ—æ–¹å¼
            value: 0,
            min: 0,
            max: pois.length - 1, //poisä¸ºè·¯ä¹¦æ•°æ®
        });
        processEl.on("change", function (obj) { //æ»‘åŠ¨æ¡æ”¹å˜äº‹ä»¶
            if (lushu.i < obj.value.newValue) {  //å¿«è¿› å¦‚æœæ»‘åŠ¨æ¡çš„è¿›åº¦å¤§äºè·¯ä¹¦å½“å‰çš„è¿›åº¦ï¼Œåˆ™æŠŠæ»‘åŠ¨æ¡è®¾ç½®ä¸ºè·¯ä¹¦å½“å‰çš„è¿›åº¦                               
                $('#process').slider('value', lushu.i);
                // lushu.i = obj.value.newValue;
            } else {  //åé€€
                lushu.i = obj.value.newValue;
            }
            if (obj.value.newValue == pois.length - 1) {
                pause();
            }
		});

    
        // å®šä¹‰å¼€å§‹ã€æš‚åœã€ç»§ç»­ã€åœæ­¢å‡½æ•°
        function start() {
            lushu.start();
        }
        function pause() {
            lushu.pause();
        }
        function resume() {
            lushu.start();
        }
        function stop() {
            lushu.stop();
        }

        

        //==========æ ‡æ³¨ç‚¹==============
        class CustomMarkerManager {
            /**
             * è‡ªå®šä¹‰æ ‡æ³¨ç®¡ç†å™¨
             * @param {BMap.Map} map - ç™¾åº¦åœ°å›¾å®ä¾‹
             * @param {Object} options - é…ç½®é€‰é¡¹
             * @param {string} options.iconUrl - æ ‡æ³¨å›¾æ ‡è·¯å¾„
             * @param {number[]} options.iconSize - å›¾æ ‡å°ºå¯¸ [å®½, é«˜]
             * @param {string} options.labelBgUrl - æ ‡ç­¾èƒŒæ™¯å›¾è·¯å¾„
             */
            constructor(map, options = {}) {
                this.map = map;
                this.activeLabel = null;
                this.markers = [];
                this.openInfoBox = options.openBox; // æ³¨å…¥å¤–éƒ¨æ–¹æ³•
            }

            /**
             * æ·»åŠ æ ‡æ³¨ç‚¹ç»„
             * @param {Array} pointsData - æ ‡æ³¨ç‚¹æ•°æ®æ•°ç»„
             */
            addMarkers(pointsData) {
                pointsData.forEach(pointData => {
                    const [lng, lat] = pointData.path.split(',').map(Number);
                    const point = new BMap.Point(lng, lat);
                    
                    const customIcon = new BMap.Icon(
                        './public/static/images/sanj.png',
                        new BMap.Size(20, 20),
                        {
                            anchor: new BMap.Size(20, 20), // å›¾æ ‡é”šç‚¹ï¼ˆç›¸å¯¹äºå·¦ä¸Šè§’çš„åç§»ï¼‰
                            imageOffset: new BMap.Size(0, 0) // å¤§å›¾å‰ªåˆ‡èµ·å§‹ä½ç½®ï¼ˆç”¨äºé›ªç¢§å›¾ï¼‰
                        }
                    );
                    // åˆ›å»ºæ ‡æ³¨[7](@ref)
                    const marker = new BMap.Marker(point, {
                        icon: customIcon,
                        enableClicking: true
                    });
                    
                    // åˆ›å»ºæ ‡ç­¾
                    const label = this._createLabel(point, pointData.text);
                    // ç»‘å®šäº‹ä»¶
                    label.addEventListener("click", (e) => this._handleLabelClick(e, marker, pointData));
                    
                    marker.setLabel(label);
                    this.map.addOverlay(marker);
                    this.markers.push(marker); // å­˜å‚¨å¼•ç”¨
                });
            }

            /**
             * åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾
             * @private
             */
            _createLabel(point, text) {
                const label = new BMap.Label(text, { position: point });
                label.setStyle({
                    display: 'flex',
                    alignItems: 'center',
                    border: 'none',
                    paddingLeft: '40px',
                    paddingRight: '10px',
                    borderRadius: '18px',
                    height: '36px',
                    fontSize: '16px',
                    transform: 'translateX(-70%) translateY(-80%)',
                    backgroundImage: `url("./public/static/images/jiay.png")`,
                    backgroundSize: '30px',
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: '4px 50%'
                });
                
                return label;
            }
            /**
             * æ ‡ç­¾ç‚¹å‡»äº‹ä»¶å¤„ç†
             * @private
             */
            _handleLabelClick(e, marker, pointData) {
                e.domEvent.stopPropagation();
                // ç”Ÿæˆä¿¡æ¯æ¡†å†…å®¹[5](@ref)
                const infoContent = `
                    <div class="custom-infobox">
                        <div class="info-header">
                            <h3 style="margin:0">${pointData.title || 'ä½ç½®ä¿¡æ¯'}</h3>
                        </div>
                        <div class="info-body">
                            <p>ğŸ“ ${pointData.address || 'åœ°å€æœªæä¾›'}</p>
                            ${pointData.phone ? `<p>ğŸ“ ${pointData.phone}</p>` : ''}
                        </div>
                    </div>
                `;
                if (typeof this.openInfoBox === 'function') {
                    this.openInfoBox(marker.getPosition(), infoContent);
                }
                this.setLabelStyle("#F56C6C", "#fff", e.target)
            }
            /**
             * æ¸…é™¤æ‰€æœ‰æ ‡æ³¨
             */
            clearAllMarkers() {
                this.markers.forEach(marker => this.map.removeOverlay(marker));
                this.markers = [];
                this.activeLabel = null;
            }
            //é‡ç½®labelæ ·å¼
            resetLabelStyle(){
                if(this.activeLabel){
                    this.activeLabel.setStyle({
                        backgroundColor: "#fff", // ç›®æ ‡é¢œè‰²
                        color: "#333" // æ–‡å­—é¢œè‰²åŒæ­¥è°ƒæ•´
                    });
                    this.activeLabel = null
                }
            }
            //è®¾ç½®labelé«˜äº®æ ·å¼
            setLabelStyle(backgroundColor,color,label){
                if(label){
                    this.activeLabel = label
                    this.activeLabel.setStyle({
                        backgroundColor: backgroundColor, // ç›®æ ‡é¢œè‰²
                        color: color // æ–‡å­—é¢œè‰²åŒæ­¥è°ƒæ•´
                    });
                }
            }
        }

        // 1. ç­›é€‰éœ€è¦æ·»åŠ æ ‡æ³¨çš„ç‚¹
        const marker2Points = latLngArray.filter(item => item.marker === '2');
        var markerManager = new CustomMarkerManager(map, {
            openBox: (infoBoxPos, infoContent) => {openBox(infoBoxPos, infoContent)}
        });
        markerManager.addMarkers(marker2Points);

        let currentInfoBox = null;
        // åˆ›å»ºInfoBoxæ—¶ç»‘å®šåœ°å›¾ç‚¹å‡»äº‹ä»¶
        function openBox(infoBoxPos, infoContent) {
            // å…³é—­å·²æœ‰å¼¹çª—ï¼ˆWebpage 6æ–¹æ¡ˆï¼‰
            if (currentInfoBox) {
                currentInfoBox.close();
                currentInfoBox = null;
            }
            const infoWindow = new BMapLib.InfoBox(map, infoContent, { 
                boxStyle: {
                    width: "300px",
                    padding: "0",
                    borderRadius: "10px"
                },
                closeIconUrl: './public/static/images/jiay.png',
                enableAutoPan: true,
                offset: new BMap.Size(0, -200),
            });
            // ç›‘å¬å¼¹çª—æ‰“å¼€äº‹ä»¶ï¼ˆWebpage 2åŸç†ï¼‰
            infoWindow.addEventListener("open", function() {
                // æ ‡è®°å½“å‰æ´»åŠ¨å¼¹çª—
                currentInfoBox = infoWindow;
                // ç»‘å®šåœ°å›¾ç‚¹å‡»äº‹ä»¶ï¼ˆWebpage 6å®ç°æ€è·¯ï¼‰
                map.addEventListener('click', mapClickHandler);
            });
            // ç›‘å¬å¼¹çª—å…³é—­äº‹ä»¶
            infoWindow.addEventListener("close", () => {
                map.removeEventListener('click', mapClickHandler); // ç§»é™¤äº‹ä»¶ç›‘å¬
                currentInfoBox = null;
                markerManager.resetLabelStyle()
            });
            infoWindow.open(infoBoxPos);
        }
        // åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨ï¼ˆWebpage 7ä¼˜åŒ–ç‰ˆï¼‰
        function mapClickHandler(e) {
            // æ’é™¤å¼¹çª—å†…éƒ¨ç‚¹å‡»ï¼ˆWebpage 4çš„DOMæ£€æµ‹ï¼‰
            const isClickOnInfoBox = currentInfoBox?._div?.contains(e.domEvent.target);
            // ç‚¹å‡»åœ°å›¾ç©ºç™½åŒºåŸŸæ—¶å…³é—­å¼¹çª—
            if (!isClickOnInfoBox && currentInfoBox) {
                currentInfoBox.close();
            }
        }








 

    </script>
	</body>
	
</html>
<!-- åŸæ–‡é“¾æ¥ -->
<!-- https://2048.csdn.net/68258798a5baf817cf4c2a6a.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MTU0MzMyMiwiZXhwIjoxNzQ4OTMwOTc2LCJpYXQiOjE3NDgzMjYxNzYsInVzZXJuYW1lIjoibTBfNDUxMTMxMjEifQ.MqNkDp62fyzDG7LKKt1rXL_e3ABGUu-0tSGyZ6lG_-c&spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&utm_relevant_index=5 -->