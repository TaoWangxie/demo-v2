
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>百度地图API路书实现历史轨迹回放</title>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=03EV2mS83xtLoifvHnRm5MTx5krHDIg0"></script>
        <script type="text/javascript" src="./lushu.js"></script>
        <script type="text/javascript"  src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<!-- 路书功能 -->
        <!-- <script src="http://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js"></script> -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
        <script src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js"></script>
        <style>
            .custom-infobox {
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 20px;
                min-width: 280px;
            }
            
            .info-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .company-logo {
                width: 40px;
                height: 40px;
                margin-right: 12px;
            }
            
            .contact-btn {
                background: #4CAF50;
                color: white;
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: opacity 0.3s;
            }
            
            .contact-btn:hover {
                opacity: 0.9;
            }
            </style>
	</head>
	<body>
		<!-- 在此处添加控制按钮和滑动条 -->
		<div id="controls">
			<!-- 开始按钮 -->
			<button onclick="start()">开始</button>
			<!-- 暂停按钮 -->
			<button onclick="pause()">暂停</button>
			<!-- 继续按钮 -->
			<button onclick="resume()">继续</button>
			 <!-- 暂停按钮 -->
			<button onclick="stop()">停止</button>
            <span>播放速度</span>
            <input type="range" id="speed">
            <!-- 播放进度条 -->
			<span>播放进度</span>
			<input type="range" id="process">
		</div>
		<div id="allmap" style="position: absolute; width: 100%; top: 50px; bottom: 0px"></div>
		    
	<script type="text/javascript">
        //方法重写
        BMapLib.LuShu.prototype._move = function(initPos,targetPos,effect) {
            //进度条的设置
            $('#process').slider('setValue', this.i);
            var me = this,
                //当前的帧数
                currentCount = 0,
                //步长，米/秒
                timer = this._opts.speed / 50,
                step = this._opts.speed / (100 / timer),
                //初始坐标
                init_pos = this._projection.lngLatToPoint(initPos),
                //获取结束点的(x,y)坐标
                target_pos = this._projection.lngLatToPoint(targetPos),
                //总的步长
                count = Math.round(me._getDistance(init_pos, target_pos) / step);

            //如果小于1直接移动到下一点
            if (count < 1) {
                me._moveNext(++me.i);
                return;
            }
            //两点之间匀速移动
            me._intervalFlag = setInterval(function() {
                //两点之间当前帧数大于总帧数的时候，则说明已经完成移动
                if (currentCount >= count) {
                    clearInterval(me._intervalFlag);
                    //移动的点已经超过总的长度
                    if(me.i > me._path.length){
                        return;
                    }
                    //运行下一个点
                    me._moveNext(++me.i);
                }else {
                    currentCount++;
                    var x = effect(init_pos.x, target_pos.x, currentCount, count),
                        y = effect(init_pos.y, target_pos.y, currentCount, count),
                        pos = me._projection.pointToLngLat(new BMap.Pixel(x, y));
                    //设置marker
                    if(currentCount == 1){
                        var proPos = null;
                        if(me.i - 1 >= 0){
                            proPos = me._path[me.i - 1];
                        }
                        if(me._opts.enableRotation == true){
                            me.setRotation(proPos,initPos,targetPos);
                        }
                        // if(me._opts.autoView){
                        //     if(!me._map.getBounds().containsPoint(pos)){
                        //         me._map.setCenter(pos);
                        //     }
                        // }
                    }
                    //正在移动
                    me._marker.setPosition(pos);
                    //设置自定义overlay的位置
                    me._setInfoWin(pos);
                }
            },timer);
        }

		
        var map = new BMap.Map("allmap", { minZoom: 9, maxZoom: 19 });
        var point = new BMap.Point(116.128554, 24.294562);
        var top_left_navigation = new BMap.NavigationControl();
        map.enableScrollWheelZoom();//启用滚轮放大缩小
		//中心点坐标
		var carCenterPoint = new BMap.Point(113.400827,23.17394);
		map.centerAndZoom(carCenterPoint , 16);
		
		var pois = [];
        var latLngArray = [
			{path:"113.408984,23.174023", color:'#67C23A', marker: '1', text: '' },
            {path:"113.406639,23.174023", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.403944,23.173566", color:'#67C23A', marker: '2', text: '故障'  },
            {path:"113.400827,23.17394", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.397468,23.174496", color:'#409EFF', marker: '2', text: '停车'  },
            {path:"113.391494,23.174513", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.389032,23.174588", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388736,23.173217", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388511,23.171888", color:'#F56C6C', marker: '2', text: '事故出厂'  },
            {path:"113.388592,23.170501", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.38861,23.170219", color:'#F56C6C', marker: '2', text: '充电'  },
            {path:"113.38861,23.168342", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.388574,23.165218", color:'#F56C6C', marker: '1', text: ''  },
		];


        //============绘制路径===============
        // 步骤1: 转换数据结构
        const points = latLngArray.map(item => {
            const [lng, lat] = item.path.split(',').map(coord => parseFloat(coord).toFixed(6)); // 保留6位小数
            return {
                point: new BMap.Point(lng, lat),
                color: item.color
            };
        });

        // 步骤2: 自动分段逻辑
        let segments = [];
        let currentColor = points[0].color;
        let startIdx = 0;
        for (let i = 1; i < points.length; i++) {
            if (points[i].color !== currentColor) {
                // 当前段包含 startIdx 到 i（含i作为端点）
                segments.push({
                    start: startIdx,
                    end: i,          // 原为 i-1，现改为包含i
                    color: currentColor
                });
                currentColor = points[i].color;
                startIdx = i;        // 新段从i开始（复用当前点）
            }
        }
        // 添加最后一段时需包含剩余点
        segments.push({ start: startIdx, end: points.length - 1, color: currentColor });
        // 步骤3: 绘制各段路径
        segments.forEach(seg => {
            // 提取本段点坐标
            const subPoints = points.slice(seg.start, seg.end + 1).map(p => p.point);
            pois.push(...subPoints);
            // 创建线段（至少2个点）
            if (subPoints.length >= 2) {
                const polyline = new BMap.Polyline(subPoints, {
                    strokeColor: seg.color,
                    strokeWeight: 10,
                    strokeOpacity: 1,
                    enableClicking: true 
                });
                polyline.segmentColor = seg.color;
                polyline.addEventListener('click', function(e) {
                    markerManager.resetLabelStyle()
                    let infoBoxPos = e.point;
                    const clickedColor = this.segmentColor;
                    const infoContent = `
                        <div class="custom-infobox">
                            <div class="info-header">
                                <h3 style="margin:0">厦门创意互动网络</h3>
                            </div>
                            <div class="info-body">
                                <p>${clickedColor}</p>
                            </div>
                        </div>
                    `;
                    openBox(infoBoxPos, infoContent)
                });
                map.addOverlay(polyline);
            }
        });


        //======================绘制路书================
		//添加路书图标
		var ls_icons = new BMap.Icon("./public/static/images/car_move_icon.png", new BMap.Size(42, 22),{imageSize: new BMap.Size(42, 22)});
		//路书默认信息窗口内容
		var trackContent = "某车辆轨迹回放";
		//添加路书
		var lushu = new BMapLib.LuShu(map,pois,{
			defaultContent: trackContent,
			icon: ls_icons,
			autoView: false,//是否开启自动视野调整，如果开启那么路书在运动过程中会根据视野自动调整
			speed: 50,
			enableRotation: true,//是否设置marker随着道路的走向进行旋转
            landmarkPois: [],
		});
        var speedEl = new Slider('#speed', {
			min: 1, //最小值
			max: 500, //最大值
			step: 50, //步长
			value: 100, //默认值
		});
		speedEl.on("change", function (obj) { //滑动条改变事件
			var value = obj.newValue;
			if (lushu != null) {
				lushu._opts.speed = parseInt(value);
			}			
		});
        var processEl = $('#process').slider({
            orientation: "horizontal", //排列方式
            value: 0,
            min: 0,
            max: pois.length - 1, //pois为路书数据
        });
        processEl.on("change", function (obj) { //滑动条改变事件
            if (lushu.i < obj.value.newValue) {  //快进 如果滑动条的进度大于路书当前的进度，则把滑动条设置为路书当前的进度                               
                $('#process').slider('value', lushu.i);
                // lushu.i = obj.value.newValue;
            } else {  //后退
                lushu.i = obj.value.newValue;
            }
            if (obj.value.newValue == pois.length - 1) {
                pause();
            }
		});

    
        // 定义开始、暂停、继续、停止函数
        function start() {
            lushu.start();
        }
        function pause() {
            lushu.pause();
        }
        function resume() {
            lushu.start();
        }
        function stop() {
            lushu.stop();
        }

        

        //==========标注点==============
        class CustomMarkerManager {
            /**
             * 自定义标注管理器
             * @param {BMap.Map} map - 百度地图实例
             * @param {Object} options - 配置选项
             * @param {string} options.iconUrl - 标注图标路径
             * @param {number[]} options.iconSize - 图标尺寸 [宽, 高]
             * @param {string} options.labelBgUrl - 标签背景图路径
             */
            constructor(map, options = {}) {
                this.map = map;
                this.activeLabel = null;
                this.markers = [];
                this.openInfoBox = options.openBox; // 注入外部方法
            }

            /**
             * 添加标注点组
             * @param {Array} pointsData - 标注点数据数组
             */
            addMarkers(pointsData) {
                pointsData.forEach(pointData => {
                    const [lng, lat] = pointData.path.split(',').map(Number);
                    const point = new BMap.Point(lng, lat);
                    
                    const customIcon = new BMap.Icon(
                        './public/static/images/sanj.png',
                        new BMap.Size(20, 20),
                        {
                            anchor: new BMap.Size(20, 20), // 图标锚点（相对于左上角的偏移）
                            imageOffset: new BMap.Size(0, 0) // 大图剪切起始位置（用于雪碧图）
                        }
                    );
                    // 创建标注[7](@ref)
                    const marker = new BMap.Marker(point, {
                        icon: customIcon,
                        enableClicking: true
                    });
                    
                    // 创建标签
                    const label = this._createLabel(point, pointData.text);
                    // 绑定事件
                    label.addEventListener("click", (e) => this._handleLabelClick(e, marker, pointData));
                    
                    marker.setLabel(label);
                    this.map.addOverlay(marker);
                    this.markers.push(marker); // 存储引用
                });
            }

            /**
             * 创建自定义标签
             * @private
             */
            _createLabel(point, text) {
                const label = new BMap.Label(text, { position: point });
                label.setStyle({
                    display: 'flex',
                    alignItems: 'center',
                    border: 'none',
                    paddingLeft: '40px',
                    paddingRight: '10px',
                    borderRadius: '18px',
                    height: '36px',
                    fontSize: '16px',
                    transform: 'translateX(-70%) translateY(-80%)',
                    backgroundImage: `url("./public/static/images/jiay.png")`,
                    backgroundSize: '30px',
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: '4px 50%'
                });
                
                return label;
            }
            /**
             * 标签点击事件处理
             * @private
             */
            _handleLabelClick(e, marker, pointData) {
                e.domEvent.stopPropagation();
                // 生成信息框内容[5](@ref)
                const infoContent = `
                    <div class="custom-infobox">
                        <div class="info-header">
                            <h3 style="margin:0">${pointData.title || '位置信息'}</h3>
                        </div>
                        <div class="info-body">
                            <p>📍 ${pointData.address || '地址未提供'}</p>
                            ${pointData.phone ? `<p>📞 ${pointData.phone}</p>` : ''}
                        </div>
                    </div>
                `;
                if (typeof this.openInfoBox === 'function') {
                    this.openInfoBox(marker.getPosition(), infoContent);
                }
                this.setLabelStyle("#F56C6C", "#fff", e.target)
            }
            /**
             * 清除所有标注
             */
            clearAllMarkers() {
                this.markers.forEach(marker => this.map.removeOverlay(marker));
                this.markers = [];
                this.activeLabel = null;
            }
            //重置label样式
            resetLabelStyle(){
                if(this.activeLabel){
                    this.activeLabel.setStyle({
                        backgroundColor: "#fff", // 目标颜色
                        color: "#333" // 文字颜色同步调整
                    });
                    this.activeLabel = null
                }
            }
            //设置label高亮样式
            setLabelStyle(backgroundColor,color,label){
                if(label){
                    this.activeLabel = label
                    this.activeLabel.setStyle({
                        backgroundColor: backgroundColor, // 目标颜色
                        color: color // 文字颜色同步调整
                    });
                }
            }
        }

        // 1. 筛选需要添加标注的点
        const marker2Points = latLngArray.filter(item => item.marker === '2');
        var markerManager = new CustomMarkerManager(map, {
            openBox: (infoBoxPos, infoContent) => {openBox(infoBoxPos, infoContent)}
        });
        markerManager.addMarkers(marker2Points);

        let currentInfoBox = null;
        // 创建InfoBox时绑定地图点击事件
        function openBox(infoBoxPos, infoContent) {
            // 关闭已有弹窗（Webpage 6方案）
            if (currentInfoBox) {
                currentInfoBox.close();
                currentInfoBox = null;
            }
            const infoWindow = new BMapLib.InfoBox(map, infoContent, { 
                boxStyle: {
                    width: "300px",
                    padding: "0",
                    borderRadius: "10px"
                },
                closeIconUrl: './public/static/images/jiay.png',
                enableAutoPan: true,
                offset: new BMap.Size(0, -200),
            });
            // 监听弹窗打开事件（Webpage 2原理）
            infoWindow.addEventListener("open", function() {
                // 标记当前活动弹窗
                currentInfoBox = infoWindow;
                // 绑定地图点击事件（Webpage 6实现思路）
                map.addEventListener('click', mapClickHandler);
            });
            // 监听弹窗关闭事件
            infoWindow.addEventListener("close", () => {
                map.removeEventListener('click', mapClickHandler); // 移除事件监听
                currentInfoBox = null;
                markerManager.resetLabelStyle()
            });
            infoWindow.open(infoBoxPos);
        }
        // 地图点击事件处理器（Webpage 7优化版）
        function mapClickHandler(e) {
            // 排除弹窗内部点击（Webpage 4的DOM检测）
            const isClickOnInfoBox = currentInfoBox?._div?.contains(e.domEvent.target);
            // 点击地图空白区域时关闭弹窗
            if (!isClickOnInfoBox && currentInfoBox) {
                currentInfoBox.close();
            }
        }








 

    </script>
	</body>
	
</html>
<!-- 原文链接 -->
<!-- https://2048.csdn.net/68258798a5baf817cf4c2a6a.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MTU0MzMyMiwiZXhwIjoxNzQ4OTMwOTc2LCJpYXQiOjE3NDgzMjYxNzYsInVzZXJuYW1lIjoibTBfNDUxMTMxMjEifQ.MqNkDp62fyzDG7LKKt1rXL_e3ABGUu-0tSGyZ6lG_-c&spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&utm_relevant_index=5 -->