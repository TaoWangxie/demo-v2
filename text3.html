
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>ç™¾åº¦åœ°å›¾APIè·¯ä¹¦å®ç°å†å²è½¨è¿¹å›æ”¾</title>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=03EV2mS83xtLoifvHnRm5MTx5krHDIg0"></script>
        <script type="text/javascript" src="./lushu.js"></script>
        <script type="text/javascript"  src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<!-- è·¯ä¹¦åŠŸèƒ½ -->
        <!-- <script src="http://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js"></script> -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
        <script src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js"></script>
        <style>
            .custom-infobox {
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 20px;
                min-width: 280px;
            }
            
            .info-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .company-logo {
                width: 40px;
                height: 40px;
                margin-right: 12px;
            }
            
            .contact-btn {
                background: #4CAF50;
                color: white;
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: opacity 0.3s;
            }
            
            .contact-btn:hover {
                opacity: 0.9;
            }
            </style>
	</head>
	<body>
		<!-- åœ¨æ­¤å¤„æ·»åŠ æ§åˆ¶æŒ‰é’®å’Œæ»‘åŠ¨æ¡ -->
		<div id="controls">
			<!-- å¼€å§‹æŒ‰é’® -->
			<button onclick="start()">å¼€å§‹</button>
			<!-- æš‚åœæŒ‰é’® -->
			<button onclick="pause()">æš‚åœ</button>
			<!-- ç»§ç»­æŒ‰é’® -->
			<button onclick="resume()">ç»§ç»­</button>
			 <!-- æš‚åœæŒ‰é’® -->
			<button onclick="stop()">åœæ­¢</button>
            <span>æ’­æ”¾é€Ÿåº¦</span>
            <input type="range" id="speed">
            <!-- æ’­æ”¾è¿›åº¦æ¡ -->
			<span>æ’­æ”¾è¿›åº¦</span>
			<input type="range" id="process">
		</div>
		<div id="allmap" style="position: absolute; width: 100%; top: 50px; bottom: 0px"></div>
		    
	<script type="text/javascript">

        class TrafficRouteMap {
            /**
             * äº¤é€šè·¯çº¿åœ°å›¾ç®¡ç†å™¨
             * @param {string} containerId - åœ°å›¾å®¹å™¨ID
             * @param {Object} options - é…ç½®é€‰é¡¹
             * @param {BMap.Point} options.centerPoint - åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡
             * @param {number} options.zoomLevel - åˆå§‹ç¼©æ”¾çº§åˆ«
             * @param {string} options.carIconUrl - è·¯ä¹¦è½¦è¾†å›¾æ ‡è·¯å¾„
             * @param {string} options.markerIconUrl - æ ‡æ³¨ç‚¹å›¾æ ‡è·¯å¾„
             */
            constructor(containerId, options = {}) {
                // åœ°å›¾å®ä¾‹
                this.map = new BMap.Map(containerId, { 
                    minZoom: 9, 
                    maxZoom: 19 
                });
                
                // é…ç½®å‚æ•°
                this.options = Object.assign({
                    centerPoint: new BMap.Point(113.400827, 23.17394),
                    zoomLevel: 16,
                    carIconUrl: "./public/static/images/car_move_icon.png",
                    markerIconUrl: "./public/static/images/sanj.png",
                }, options);

                // åˆå§‹åŒ–åœ°å›¾
                this._initMap();
                
                // æ ¸å¿ƒç»„ä»¶
                this.lushu = null;          // è·¯ä¹¦å®ä¾‹
                this.activeLabel = null;    // å½“å‰æ¿€æ´»çš„æ ‡ç­¾
                this.currentInfoBox = null; // å½“å‰ä¿¡æ¯çª—å£
                this.markers = [];          // å­˜å‚¨æ‰€æœ‰æ ‡æ³¨ç‚¹
                this.pois = [];             // å­˜å‚¨è·¯å¾„ç‚¹
            }

            // ==================== ç§æœ‰æ–¹æ³• ====================
            _initMap() {
                // æ·»åŠ åœ°å›¾æ§ä»¶
                this.map.addControl(new BMap.NavigationControl());
                this.map.enableScrollWheelZoom();
                this.map.centerAndZoom(this.options.centerPoint, this.options.zoomLevel);
            }

            // ==================== è·¯å¾„ç®¡ç† ====================
            /**
             * ç»˜åˆ¶åˆ†æ®µé¢œè‰²è·¯å¾„
             * @param {Array} pathData - è·¯å¾„æ•°æ®æ•°ç»„
             */
            drawPath(pathData) {
                // 1. è½¬æ¢æ•°æ®ç»“æ„
                const points = pathData.map(item => {
                    const [lng, lat] = item.path.split(',').map(Number);
                    return {
                        point: new BMap.Point(lng, lat),
                        color: item.color,
                        marker: item.marker,
                        text: item.text
                    };
                });
                // 2. è‡ªåŠ¨é¢œè‰²åˆ†æ®µ
                let segments = [];
                let currentColor = points[0].color;
                let startIdx = 0;
                for (let i = 1; i < points.length; i++) {
                    if (points[i].color !== currentColor) {
                        segments.push({
                            start: startIdx,
                            end: i,
                            color: currentColor
                        });
                        currentColor = points[i].color;
                        startIdx = i;
                    }
                }
                segments.push({ 
                    start: startIdx, 
                    end: points.length - 1, 
                    color: currentColor 
                });
                // 3. ç»˜åˆ¶å„æ®µè·¯å¾„
                this.pois = [];
                segments.forEach(seg => {
                    const subPoints = points.slice(seg.start, seg.end + 1).map(p => p.point);
                    this.pois.push(...subPoints);
                    if (subPoints.length >= 2) {
                        const polyline = new BMap.Polyline(subPoints, {
                            strokeColor: seg.color,
                            strokeWeight: 10,
                            strokeOpacity: 1,
                            enableClicking: true 
                        });
                        // å­˜å‚¨åˆ†æ®µé¢œè‰²ç”¨äºç‚¹å‡»äº‹ä»¶
                        polyline.segmentColor = seg.color;
                        // ç»‘å®šç‚¹å‡»äº‹ä»¶
                        polyline.addEventListener('click', (e) => {
                            this.resetLabelStyle();
                            this.openInfoBox(e.point, `
                                <div class="custom-infobox">
                                    <div class="info-header">
                                        <h3 style="margin:0">è·¯æ®µä¿¡æ¯</h3>
                                    </div>
                                    <div class="info-body">
                                        <p>çŠ¶æ€: ${this._getStatusByColor(seg.color)}</p>
                                    </div>
                                </div>
                            `);
                        });
                        this.map.addOverlay(polyline);
                    }
                });
                return this.pois;
            }

            // æ ¹æ®é¢œè‰²è·å–çŠ¶æ€æè¿°
            _getStatusByColor(color) {
                const statusMap = {
                    '#67C23A': 'æ­£å¸¸è¿è¡Œ',
                    '#409EFF': 'åœè½¦çŠ¶æ€',
                    '#F56C6C': 'å¼‚å¸¸çŠ¶æ€'
                };
                return statusMap[color] || 'æœªçŸ¥çŠ¶æ€';
            }

            // ==================== è·¯ä¹¦ç®¡ç† ====================
            /**
             * åˆå§‹åŒ–è·¯ä¹¦è½¨è¿¹
             * @param {Object} options - è·¯ä¹¦é…ç½®
             */
            initLushu(options = {}) {
                const defaultOptions = {
                    defaultContent: "è½¦è¾†è½¨è¿¹å›æ”¾",
                    icon: new BMap.Icon(
                        this.options.carIconUrl, 
                        new BMap.Size(42, 22),
                        { imageSize: new BMap.Size(42, 22) }
                    ),
                    autoView: false,
                    speed: 50,
                    enableRotation: true,
                    landmarkPois: []
                };

                this.lushu = new BMapLib.LuShu(
                    this.map, 
                    this.pois,
                    Object.assign(defaultOptions, options)
                );
                
                // é‡å†™è·¯ä¹¦ç§»åŠ¨æ–¹æ³•ï¼ˆæ·»åŠ è¿›åº¦æ¡æ”¯æŒï¼‰
                if (this.lushu) {
                    const originalMove = BMapLib.LuShu.prototype._move;
                    BMapLib.LuShu.prototype._move = function(initPos, targetPos, effect) {
                        // è¿›åº¦æ¡æ›´æ–°é€»è¾‘
                        $('#process').slider('setValue', this.i);
                        originalMove.call(this, initPos, targetPos, effect);
                    };
                    this.initSliders();
                }
            }
            initSliders() {
                if(this.options?.speedId){
                    // é€Ÿåº¦æ»‘å—
                    const speedEl = new Slider(this.options.speedId, {
                        min: 1, //æœ€å°å€¼
                        max: 500, //æœ€å¤§å€¼
                        step: 50, //æ­¥é•¿
                        value: 100, //é»˜è®¤å€¼
                    });
                    speedEl.on("change", (obj) => { // ä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿thisæŒ‡å‘ç±»å®ä¾‹
                        const value = obj.newValue;
                        if (this.lushu != null) {
                            this.lushu._opts.speed = parseInt(value);
                        }
                    });
                }
 
                if(this.options?.processId){
                    // è¿›åº¦æ»‘å—
                    const processEl = $(this.options.processId).slider({
                        orientation: "horizontal", //æ’åˆ—æ–¹å¼
                        value: 0,
                        min: 0,
                        max: this.pois.length - 1, //poisä¸ºè·¯ä¹¦æ•°æ®
                    });
                    processEl.on("change", (obj) => { // ä½¿ç”¨ç®­å¤´å‡½æ•°
                        if (this.lushu.i < obj.value.newValue) {  //å¿«è¿›
                            // å¦‚æœæ»‘åŠ¨æ¡çš„è¿›åº¦å¤§äºè·¯ä¹¦å½“å‰çš„è¿›åº¦ï¼Œåˆ™æŠŠæ»‘åŠ¨æ¡è®¾ç½®ä¸ºè·¯ä¹¦å½“å‰çš„è¿›åº¦
                            $('#process').slider('value', this.lushu.i);
                        } else {  //åé€€
                            this.lushu.i = obj.value.newValue;
                        }
                        if (obj.value.newValue == this.pois.length - 1) {
                            this.pauseLushu(); // åˆ°è¾¾ç»ˆç‚¹æ—¶æš‚åœ
                        }
                    });
                }
            }
            // è·¯ä¹¦æ§åˆ¶æ–¹æ³•
            startLushu() { this.lushu?.start(); }
            pauseLushu() { this.lushu?.pause(); }
            resumeLushu() { this.lushu?.start(); }
            stopLushu() { this.lushu?.stop(); }
            setLushuSpeed(speed) { 
                if (this.lushu) this.lushu._opts.speed = speed; 
            }
            // ==================== æ ‡æ³¨ç®¡ç† ====================
            /**
             * æ·»åŠ æ ‡æ³¨ç‚¹
             * @param {Array} markerData - æ ‡æ³¨ç‚¹æ•°æ®
             */
            addMarkers(markerData) {
                // ç­›é€‰éœ€è¦æ·»åŠ æ ‡æ³¨çš„ç‚¹ (marker === '2')
                const pointsData = markerData.filter(item => item.marker === '2');
                pointsData.forEach(pointData => {
                    const [lng, lat] = pointData.path.split(',').map(Number);
                    const point = new BMap.Point(lng, lat);
                    // åˆ›å»ºæ ‡æ³¨å›¾æ ‡
                    const customIcon = new BMap.Icon(
                        this.options.markerIconUrl,
                        new BMap.Size(20, 20),
                        { anchor: new BMap.Size(20, 20) }
                    );
                    // åˆ›å»ºæ ‡æ³¨
                    const marker = new BMap.Marker(point, {
                        icon: customIcon,
                        enableClicking: true
                    });
                    // åˆ›å»ºæ ‡ç­¾
                    const label = this._createLabel(point, pointData.text);
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    label.addEventListener("click", (e) => {
                        const infoContent = `
                            <div class="custom-infobox">
                                <div class="info-header">
                                    <h3 style="margin:0">${pointData.title || 'ä½ç½®ä¿¡æ¯'}</h3>
                                </div>
                                <div class="info-body">
                                    <p>ğŸ“ ${pointData.address || 'åœ°å€æœªæä¾›'}</p>
                                    ${pointData.phone ? `<p>ğŸ“ ${pointData.phone}</p>` : ''}
                                </div>
                            </div>
                        `;
                        this.openInfoBox(marker.getPosition(), infoContent);
                        this.setLabelStyle("#F56C6C", "#fff", e.target);
                    });
                    marker.setLabel(label);
                    this.map.addOverlay(marker);
                    this.markers.push(marker);
                });
            }
            /**
             * åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾
             * @private
             */
            _createLabel(point, text) {
                const label = new BMap.Label(text, { position: point });
                label.setStyle({
                    display: 'flex',
                    alignItems: 'center',
                    border: 'none',
                    paddingLeft: '40px',
                    paddingRight: '10px',
                    borderRadius: '18px',
                    height: '36px',
                    fontSize: '16px',
                    transform: 'translateX(-70%) translateY(-80%)',
                    backgroundImage: `url("./public/static/images/jiay.png")`,
                    backgroundSize: '30px',
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: '4px 50%'
                });
                return label;
            }

            /**
             * é‡ç½®æ ‡ç­¾æ ·å¼
             */
            resetLabelStyle() {
                if (this.activeLabel) {
                    this.activeLabel.setStyle({
                        backgroundColor: "#fff",
                        color: "#333"
                    });
                    this.activeLabel = null;
                }
            }
            /**
             * è®¾ç½®æ ‡ç­¾é«˜äº®æ ·å¼
             * @param {string} backgroundColor - èƒŒæ™¯è‰²
             * @param {string} color - æ–‡å­—é¢œè‰²
             * @param {BMap.Label} label - æ ‡ç­¾å®ä¾‹
             */
            setLabelStyle(backgroundColor, color, label) {
                if (label) {
                    this.activeLabel = label;
                    this.activeLabel.setStyle({
                        backgroundColor: backgroundColor,
                        color: color
                    });
                }
            }
            /**
             * æ¸…é™¤æ‰€æœ‰æ ‡æ³¨
             */
            clearAllMarkers() {
                this.markers.forEach(marker => this.map.removeOverlay(marker));
                this.markers = [];
                this.activeLabel = null;
            }

            // ==================== ä¿¡æ¯çª—å£ç®¡ç† ====================
            /**
             * æ‰“å¼€ä¿¡æ¯çª—å£
             * @param {BMap.Point} position - ä¿¡æ¯çª—å£ä½ç½®
             * @param {string} content - HTMLå†…å®¹
             */
            openInfoBox(position, content) {
                // å…³é—­å·²æœ‰çª—å£
                this.closeInfoBox();
                const infoWindow = new BMapLib.InfoBox(this.map, content, {
                    boxStyle: {
                        width: "300px",
                        padding: "0",
                        borderRadius: "10px"
                    },
                    closeIconUrl: './public/static/images/jiay.png',
                    enableAutoPan: true,
                    offset: new BMap.Size(0, -200),
                });
                // äº‹ä»¶ç›‘å¬
                infoWindow.addEventListener("open", () => {
                    this.currentInfoBox = infoWindow;
                    this.map.addEventListener('click', this._mapClickHandler);
                });
                infoWindow.addEventListener("close", () => {
                    this.map.removeEventListener('click', this._mapClickHandler);
                    this.currentInfoBox = null;
                    this.resetLabelStyle();
                });
                infoWindow.open(position);
            }
            // å…³é—­ä¿¡æ¯çª—å£
            closeInfoBox() {
                if (this.currentInfoBox) {
                    this.currentInfoBox.close();
                    this.currentInfoBox = null;
                }
            }
            // åœ°å›¾ç‚¹å‡»å¤„ç†å™¨
            _mapClickHandler = (e) => {
                const isClickOnInfoBox = this.currentInfoBox?._div?.contains(e.domEvent.target);
                if (!isClickOnInfoBox && this.currentInfoBox) {
                    this.currentInfoBox.close();
                }
            }
            // ==================== é”€æ¯æ–¹æ³• ====================
            destroy() {
                this.closeInfoBox();
                this.stopLushu();
                this.clearAllMarkers();
                this.map = null;
            }
        }


        
        // ==================== ä½¿ç”¨ç¤ºä¾‹ ====================
        // åˆå§‹åŒ–åœ°å›¾
        const trafficMap = new TrafficRouteMap("allmap", {
            centerPoint: new BMap.Point(113.400827, 23.17394),
            zoomLevel: 16,
            speedId: '#speed',
            processId:'#process',
        });

        // è·¯å¾„æ•°æ®
        const pathData = [
            {path:"113.408984,23.174023", color:'#67C23A', marker: '1', text: '' },
            {path:"113.406639,23.174023", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.403944,23.173566", color:'#67C23A', marker: '2', text: 'æ•…éšœ'  },
            {path:"113.400827,23.17394", color:'#67C23A', marker: '1', text: ''  },
            {path:"113.397468,23.174496", color:'#409EFF', marker: '2', text: 'åœè½¦'  },
            {path:"113.391494,23.174513", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.389032,23.174588", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388736,23.173217", color:'#409EFF', marker: '1', text: ''  },
            {path:"113.388511,23.171888", color:'#F56C6C', marker: '2', text: 'äº‹æ•…å‡ºå‚'  },
            {path:"113.388592,23.170501", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.38861,23.170219", color:'#F56C6C', marker: '2', text: 'å……ç”µ'  },
            {path:"113.38861,23.168342", color:'#F56C6C', marker: '1', text: ''  },
            {path:"113.388574,23.165218", color:'#F56C6C', marker: '1', text: ''  },
        ];

        // ç»˜åˆ¶è·¯å¾„
        trafficMap.drawPath(pathData);
        // åˆå§‹åŒ–è·¯ä¹¦
        trafficMap.initLushu({
            speed: 100,
            defaultContent: "è´§è¿è½¦è¾†è½¨è¿¹"
        });
        // æ·»åŠ æ ‡æ³¨ç‚¹
        trafficMap.addMarkers(pathData);



        // å®šä¹‰å¼€å§‹ã€æš‚åœã€ç»§ç»­ã€åœæ­¢å‡½æ•°
        function start() {
            trafficMap.startLushu();
        }
        function pause() {
            trafficMap.pauseLushu();
        }
        function resume() {
            trafficMap.startLushu();
        }
        function stop() {
            trafficMap.stopLushu();
        }
        

    </script>
	</body>
	
</html>
<!-- åŸæ–‡é“¾æ¥ -->
<!-- https://2048.csdn.net/68258798a5baf817cf4c2a6a.html?dp_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MTU0MzMyMiwiZXhwIjoxNzQ4OTMwOTc2LCJpYXQiOjE3NDgzMjYxNzYsInVzZXJuYW1lIjoibTBfNDUxMTMxMjEifQ.MqNkDp62fyzDG7LKKt1rXL_e3ABGUu-0tSGyZ6lG_-c&spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Eactivity-3-131086729-blog-78200725.235%5Ev43%5Epc_blog_bottom_relevance_base8&utm_relevant_index=5 -->